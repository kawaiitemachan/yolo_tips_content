# CLAUDE.md

このファイルはこのリポジトリのコードを扱う際にClaude Code（claude.ai/code）のガイダンスを提供します。

## プロジェクト概要

これはYOLO（You Only Look Once）オブジェクト検出とセグメンテーションプロジェクトで、以下に焦点を当てています：

1. カスタムデータセットでYOLOv11nセグメンテーションモデル（`yolo11n-seg.pt`）をトレーニング
2. 検出されたオブジェクトに対してモザイク効果を適用

このプロジェクトはWindows環境で動作するように設計されており、使いやすさを考慮したワンクリックバッチファイルを提供しています。

## 主要コンポーネント

### トレーニングパイプライン
- 設定可能なYOLOv11n-segモデルトレーニング
- 自動クラス処理を備えたカスタムデータセットのサポート
- `config.yaml`による設定

### 推論パイプライン
- セグメンテーションベースの検出
- 検出領域への自動モザイク適用
- 設定可能なモザイクピクセルサイズ

## ディレクトリ構造

- `dataset/` - トレーニング/検証データと設定を含む
  - `data.yaml` - クラスとパスを定義するデータセット設定
  - `train/images/` と `train/labels/` - トレーニングデータ
  - `valid/images/` と `valid/labels/` - 検証データ

- Windowsバッチファイル：
  - `setup_environment.bat` - Python仮想環境をセットアップし依存関係をインストール
  - `train_yolov11n_seg.bat` - セグメンテーションモデルのトレーニングを開始
  - `detect_mosaic.bat` - 検出とモザイク適用を実行

- Pythonスクリプト：
  - `detect.py` - セグメンテーションとモザイク適用のメインスクリプト

- 設定：
  - `config.yaml` - トレーニング設定パラメータ

## 一般的なコマンド

### 環境のセットアップ
```
setup_environment.bat
```
これはPython仮想環境を作成し、必要な依存関係をインストールします。

### モデルのトレーニング
```
train_yolov11n_seg.bat
```
`config.yaml`の設定またはデフォルトパラメータを使用してトレーニングを開始します。

### モザイク効果による推論の実行
```
detect_mosaic.bat
```
環境を有効化し、以下のユーザー入力による検出スクリプトを実行します：
- 画像フォルダパス
- モザイクピクセルサイズ
- 検出信頼度閾値

## 重要な実装詳細

### セグメンテーションベースのモザイクアルゴリズム
`detect.py`の`apply_mosaic_to_mask`関数がセグメンテーション領域へのピクセル化処理を行います：
1. セグメンテーションマスクで定義された領域を抽出
2. ダウンサンプリングとアップサンプリングを順に適用してモザイク効果を作成
3. 画像のマスク領域のみにモザイクを適用

### データフォーマット
セグメンテーションモデルはYOLO形式のデータを期待します：
- 標準形式（jpg、png）の画像
- 正規化された座標を持つ.txtファイルのラベル

### 設定パラメータ
`config.yaml`の主要パラメータ：
- `model: yolo11n-seg.pt` - セグメンテーションモデル
- `epochs: 100` - トレーニング期間
- `imgsz: 640` - 入力画像サイズ
- `batch: 4` - トレーニングのバッチサイズ
- `device: 0` - GPUデバイス（CPUのみの場合は'cpu'を使用）

## 開発メモ

このコードベースを変更する際に考慮すべき点：

1. コードは`data.yaml`に基づいて異なるクラスを動的に処理するように設計されています
2. エンコーディングの問題を避けるため、バッチファイルでは常に英語のみのプロンプトを維持してください
3. セグメンテーションマスクはバウンディングボックスとは異なる方法で処理されます
4. 出力ディレクトリは以下のように構成されています：
   - トレーニング：`runs/segment/yolov11n_seg_custom_model/`
   - 推論：`runs/segment/mosaic_results/`